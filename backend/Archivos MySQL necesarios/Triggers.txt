DELIMITER //

-- ===========================================================
-- TRIGGER: Actualiza porcentaje de asistencia en analytics_summary
-- ===========================================================
CREATE TRIGGER trg_update_attendance_summary
AFTER INSERT ON attendance
FOR EACH ROW
BEGIN
  DECLARE total_classes INT;
  DECLARE attended_classes INT;
  DECLARE attendance_rate DECIMAL(5,2);
  DECLARE v_cycle INT;

  SELECT co.cycle_id INTO v_cycle
  FROM schedules s
  JOIN course_offerings co ON co.id = s.course_offering_id
  WHERE s.id = NEW.schedule_id
  LIMIT 1;

  SELECT COUNT(*) INTO total_classes
  FROM attendance a
  JOIN schedules s2 ON s2.id = a.schedule_id
  JOIN course_offerings co2 ON co2.id = s2.course_offering_id
  WHERE a.student_id = NEW.student_id AND co2.cycle_id = v_cycle;

  SELECT COUNT(*) INTO attended_classes
  FROM attendance a
  JOIN schedules s3 ON s3.id = a.schedule_id
  JOIN course_offerings co3 ON co3.id = s3.course_offering_id
  WHERE a.student_id = NEW.student_id AND co3.cycle_id = v_cycle AND a.status = 'presente';

  SET attendance_rate = (attended_classes / total_classes) * 100;

  INSERT INTO analytics_summary (student_id, cycle_id, attendance_pct, total_paid)
  VALUES (NEW.student_id, v_cycle, attendance_rate, 0)
  ON DUPLICATE KEY UPDATE attendance_pct = attendance_rate, updated_at = NOW();
END;
//

-- ===========================================================
-- TRIGGER: Actualiza monto total pagado en analytics_summary
-- ===========================================================
CREATE TRIGGER trg_update_payment_summary
AFTER UPDATE ON installments
FOR EACH ROW
BEGIN
  DECLARE v_student INT;
  DECLARE v_cycle INT;
  DECLARE v_total DECIMAL(10,2);

  SELECT e.student_id, 
         COALESCE(co.cycle_id, po.cycle_id)
  INTO v_student, v_cycle
  FROM payment_plans pp
  JOIN enrollments e ON e.id = pp.enrollment_id
  LEFT JOIN course_offerings co ON e.course_offering_id = co.id
  LEFT JOIN package_offerings po ON e.package_offering_id = po.id
  WHERE pp.id = NEW.payment_plan_id;

  SELECT SUM(amount)
  INTO v_total
  FROM installments i
  WHERE i.payment_plan_id = NEW.payment_plan_id AND i.status = 'paid';

  INSERT INTO analytics_summary (student_id, cycle_id, attendance_pct, total_paid)
  VALUES (v_student, v_cycle, 0, v_total)
  ON DUPLICATE KEY UPDATE total_paid = v_total, updated_at = NOW();
END;
//
DELIMITER ;
